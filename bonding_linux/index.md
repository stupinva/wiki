Объединение сетевых интерфейсов в Linux
=======================================

[[!tag linux bonding]]

Содержание
----------

[[!toc startlevel=2 levels=4]]

Введение
--------

Объединение сетевых интерфейсов в единый интерфейс с целью повышения отказоустойчивости или использования суммарной пропускной способности двух и более сетевых интерфейсов в Linux осуществляется с помощью модуля ядра, который называется `bonding`. По названию драйвера само объединение сетевых интерфейсов в Linux тоже часто называют бондингом. В случае других сетевых устройств подобное объединение может называться агрегацией, "эзерчанелом" или "портчанелом" (от имени интерфейса Ether-Channel или Port-Channel на сетевом устройстве) и т.п.

Для загрузки модуля ядра достаточно ввести команду:

    # modprobe bonding

Для того, чтобы этот модуль ядра загружался автоматически при загрузке операционной системы в Debian нужно вписать имя модуля в файл `/etc/modules`.

Модуль может создавать несколько объединённых интерфейсов, каждый из которых может работать в одном из следующих режимов:

|Название     |Код|Отказоустойчивость|Балансировка нагрузки|Описание                                                                                                                                                                                                   |
|:------------|:-:|:----------------:|:-------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|balance-rr   | 0 |        Да        |         Да          |Отправка сетевых пакетов поочередно через все агрегированные интерфейсы (политика round-robin).                                                                                                            |
|active-backup| 1 |        Да        |         Нет         |Отправка сетевых пакетов через активный интерфейс. При отказе активного интерфейса (link down и т.д.) автоматически переключается на резервный интерфейс.                                                  |
|balance-xor  | 2 |        Да        |         Да          |Передача сетевых пакетов распределяются между интерфейсами на основе формулы (могут использоваться MAC-адрес, IP-адреса или номера IP-портов). Один и тот же интерфейс работает с определенным получателем.|
|broadcast    | 3 |        Да        |         Нет         |Отправка всех сетевых пакетов через все агрегированные интерфейсы (широковещательная отправка).                                                                                                            |
|802.3ad      | 4 |        Да        |         Нет         |Link Agregation Control Protocol, LACP — IEEE 802.3ad.                                                                                                                                                     |
|balance-tlb  | 5 |        Да        |         Да          |Входящие сетевые пакеты принимаются только активным сетевым интерфейсом, исходящие распределяется в зависимости от текущей загрузки каждого интерфейса.                                                    |
|balance-alb  | 6 |        Да        |         Да          |Исходящие сетевые пакеты распределяется между интерфейсами, входящие сетевые пакеты принимаются всеми интерфейсами.                                                                                        |

Примечания:

* Для использования режимов `balance-rr`, `balance-xor` и `broadcast` на коммутаторе сети должен быть настроено статическое объединение портов (static port trunking).
* Для использования режима `802.3ad` данный режим должен поддерживаться сетевым коммутатором.
* Для использования режима `balance-alb` требуются сетевые карты, поддерживающие смену MAC-адреса.

Ручная настройка
----------------

В разных дистрибутивах Linux используются разные системы управления сетевыми интерфейсами, которые, как правило, используют в своей работе пакет утилиту `ifenslave` из одноимённого пакета. Эта утилита может не устанавливаться по умолчанию, для её установки из сетевых репозиториев нужно сначала настроить сеть или прибегнуть к использованию флеш-накопителя и компьютера, уже подключенного к сети, что может оказаться неудобным. Может оказаться проще настроить сетевой интерфейс вручную, без использования утилиты `ifenslave`.

Рассмотрим для примера ручную настройку агрегации в режиме `802.3ad`.

Загрузим модуль ядра:

    # modprobe bonding

Создадим агрегирующий интерфейс с именем bond0:

    # echo "+bond0" > /sys/class/net/bonding_masters

Переведём его в режим `802.3ad`:

    # echo "802.3ad" > /sys/class/net/bond0/bonding/mode

Настроим балансировку исходящего трафика с использованием MAC- и IP-адресов пакетов:

    # echo "layer2+3" > /sys/class/net/bond0/bonding/xmit_hash_policy

Настраиваем интервал проверки исправности связи (в миллисекундах):

    # echo "100" > /sys/class/net/bond0/bondign/miimon

Настраиваем частый обмен информацией между сторонами агрегации:

    # echo "fast" > /sys/class/net/bond0/bonding/lacp_rate

Добавляем в агрегацию сетевые интерфейсы `eno1` и `eno2`, не активируя их:

    # ip link set eno1 master bond0
    # ip link set eno2 master bond0

Активируем агрегирующий интерфейс:

    # ip link set bond0 up

Настраиваем на агрегирующем интерфейсе IP-адрес и, при необходимости, маршруты через него:

    # ip addr add 172.16.7.2/24 dev bond0
    # ip route add default dev bond0 via 172.16.7.1

Настройка в Debian
------------------

Для того, чтобы описанные выше ручные настройки восстанавливались в Debian при загрузке, нужно установить пакет `ifenslave`:

    # apt-get install ifenslave

И вписать настройки в файл `/etc/network/interfaces`:

    auto eno1
    iface eno1 inet manual
        bond-master bond0
    
    auto eno2
    iface eno2 inet manual
        bond-master bond0
    
    auto bond0
    iface bond0 inet static
        bond-slaves eno1 eno2
        bond-mode 802.3ad
        bond-xmit-hash-policy layer2+3
        bond-miimon 100
        bond-lacp-rate fast
        address 172.16.7.2/24
        gateway 172.16.7.1

Опции `bond-master` в объединяемых сетевых интерфейсах позволяют возвращать сетевой интерфейс в объединение, если зачем-то понадобится выключить и снова включить их с помощью команд `ifdown` и `ifup`:

    # ifdown eno1
    # ifup eno1

Если опцию `auto` заменить на `allow-hotplug`, то можно будет пользоваться демоном `ifplugd` для настройки сетевых интерфейсов после их физического исчезновения и возврата в систему, например, если это внешний USB-адаптер Ethernet.

Использованные материалы
------------------------

* [Механизмы агрегации сетевых каналов](https://wiki.astralinux.ru/pages/viewpage.action?pageId=158604474)
* [Preparing a bonded interface](https://www.ibm.com/docs/en/linux-on-systems?topic=connection-bonded-interface)
* [man interfaces-bond(5)](https://manpages.debian.org/testing/ifupdown-ng/interfaces-bond.5.en.html)
