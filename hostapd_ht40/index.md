Настройка hostapd с шириной канала в 40 МГц
===========================================

[[!tag hostapd wifi]]

Ранее в статье [Настройка WiFi](https://stupin.su/blog/wifi/) я уже описывал базовую настройку hostapd. Как оказалось, описанный в статье адаптер TP-Link TL-WN781ND с разъёмом PCI-E на базе чипа AR9485 от Atheros, умеет занимать полосу частот сразу двух соседних каналов. Таким образом ширина канала расширяется с 20 МГц до 40 МГц, что позволяет удвоить пропускную способность беспроводной сети.

Во-первых, проверим, поддерживает ли адаптер работу каналами шириной 40 МГц. Для этого посмотрим на вывод следующей команды:

    # iw list

Нас интересует раздел Capabilities, в котором перечислены поддерживаемые адаптером возможности:

		Capabilities: 0x116e
			HT20/HT40
			SM Power Save disabled
			RX HT20 SGI
			RX HT40 SGI
			RX STBC 1-stream
			Max AMSDU length: 3839 bytes
			DSSS/CCK HT40

По умолчанию возможности не используются, а для их включения нужно добавить в файл конфигурации `/etc/hostapd/hostapd.conf` пару опций:

    ht_capab=[HT40+][HT40-][RX-STBC1][SHORT-GI-20][SHORT-GI-40][DSSS_CCK-40]

Рассмотрим подробнее список возможностей и соответствующих им настроек:

* `HT20/HT40` - поддерживается работа с удвоенными каналами. Название опции и список каналов, которые можно объединить, можно найти в таблице ниже:

    |Частота|[HT40-]    |[HT40+]                  |
    |-------|-----------|-------------------------|
    |2,4 ГГц|5-13       |1-7 (1-9 в Европе/Японии)|
    |5 ГГц  |40,48,56,64|36,44,52,60              |

* `SM Power Save disabled` - управление энергосбережением не поддерживается,
* `RX HT20 SGI` - поддерживается укороченный интервал между пакетами на обычных каналах шириной 20 МГц, что позволяет увеличить скорость сети на 10%. Соответствующая опция называется `[SHORT-GI-20]`.
* `RX HT40 SGI` - поддерживается укороченный интервал между пакетами на каналах с удвоенной шириной 40 МГц, что позволяет увеличить скорость сети на 10%. Соответствующая опция называется `[SHORT-GI-40]`.
* `RX STBC 1-stream` - количество принимаемых "пространственных потоков" от 1 до 3. Соответствующие опции называются `[RX-STBC1]`, `[RX-STBC12]` и `[RX-STBC123]`.
* `Max AMSDU length: 3839 bytes` - максимальный размер кадра. Возможны варианты 3839 байт или 7935 байт. Значение 3839 байт поддерживается любым устройством по умолчанию. Значению 7935 байт соответствует опция `[MAX-AMSDU-7935]`.
* `DSSS/CCK HT40` - поддержка модуляции DSSS/CCK на каналах шириной 40 МГц. Соответствующая опция называется `[DSSS_CCK-40]`.

Для того, чтобы принимать подключения только от станций, поддерживающих работу с каналами удвоенной ширины, можно вписать в файл конфигурации `/etc/hostapd/hostapd.conf` дополнительную опцию:

    require_ht=1

Для того, чтобы новые настройки вступили в силу, нужно перезапустить `hostapd`. Сделать это можно следующим образом:

    # systemctl restart hostapd

Использованные материалы
------------------------

* [hostapd configuration file](https://w1.fi/cgit/hostap/plain/hostapd/hostapd.conf)
* [Wireless basic configuration: Short Guard Interval and multipath effect FAQ](https://www.sonicwall.com/support/knowledge-base/wireless-basic-configuration-short-guard-interval-and-multipath-effect-faq/170504672960493/)
* [Power Save Methods](https://howiwifi.com/2020/06/25/power-save-methods/)
