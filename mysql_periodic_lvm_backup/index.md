Периодическое резервное копирование MySQL с помощью снимков LVM
===============================================================

[[!tag mysql lvm backup restore]]

Введение
--------

Скрипт периодического резервного копирования с помощью `xtrabackup`, [[описанный ранее|mysql_periodic_xtrabackup]], не годится для снятия резервных копий баз данных, содержащих таблицы TokuDB. В таком случае есть только два корректных способа снятия резервной копии: с помощью штатной утилиты `mysqldump` и с помощью мгновенных снимков файловой системы. Способ снятия резервной копии уже описан в статье [[Настройка реплики MySQL с помощью снимков LVM и rysnc|mysql_slave_lvm_rsync]]. Команда `rsync` в данном случае будет вызываться для локального копирования файлов в новый каталог резервной копии или для обновления резервной копии в каталоге с ранее созданной резервной копией. Для задач резервного копирования позиция в журнале репликации нас не интересует, но на всякий случай можно её сохранить. Сохраняться она будет в файл с именем `xtrabackup_binlog_info` внутри каталога с файлами резервной копии баз данных.

Скрипт резервного копирования
-----------------------------

Для автоматизации резервного копирования с помощью мгновенных снимков я написал скрипт [[lvbackup.sh]]. Настроить скрипт можно с помощью файла конфигурации `/etc/lvbackup.conf`, внутри которого имеются следующие настройки:

* `PVNAME` - группа томов, на которой находятся файлы баз данных MySQL,
* `LVNAME` - логический том, на котором находятся файлы баз данных MySQL,
* `LVSNAP` - имя логического тома с мгновенным снимком, который будет создан во время работы скрипта,
* `SNAP_PATH` - каталог, в который нужно смонтировать мгновенный снимок для копирования,
* `SRC` - относительный путь к каталогу с файлами баз данных на смонтированном мгновенном снимке. Если файлы баз данных находятся прямо в корне раздела, то в качестве имени можно указать точку - обозначение текущего каталога,
* `BACKUP_PATH` - каталог для резервных копий. В этом каталоге будет создан подкаталог `db`, содержащий внутри себя резервную копию файлов баз данных,
* `FOLLOW` - чью позицию из журнала репликации нужно сохранить в файл `xtrabackup_binlog_info`: `master` - файл будет содержать позицию из журнала репликации сервера, являющегося для текущего источником, `me` - файл будет содержать позицию из журнала репликации, который пишет текущий сервер,
* `RUSER` - имя пользователя на удалённом сервере,
* `RSERVER` - доменное имя или IP-адрес удалённого сервера, на который нужно скопировать архив с резервной копией,
* `RPATH` - путь к файлу архива на удалённом сервере,
* `RKEY` - путь к приватному ключу пользователя на удалённом сервере для подключения по SSH,
* `DAYS` - сколько архивов с резервной копией необходимо сохранять локально.
