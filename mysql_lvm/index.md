Резервное копирование и настройка репликации MySQL с помощью LVM
================================================================

[[!tag mysql lvm backup restore snapshot]]

Содержание
----------

[[!toc startlevel=2 levels=4]]

Введение
--------

Кроме использования штатной утилиты `mysqldump` для резервного копирования баз данных можно воспользоваться мгновенными снимками файловой системы. Стоит отметить, что мгновенные снимки уступают в гибкости штатной утилите, т.к. с их помощью можно снять только полную резервную копию всех баз данных, в то время как с помощью штатной утилиты можно снимать резервные копии отдельных баз данных, таблиц или даже частей таблиц.

Из более-менее распространённых файловых систем, имеющих поддержку мгновенных снимков можно назвать:

* UFS2 во FreeBSD,
* BtrFS в Linux,
* ZFS в Solaris, FreeBSD, NetBSD и, с некоторыми оговорками, в Linux.

Кроме этого, даже если файловая система сама по себе не позволяет создавать снимки, снимки файловой системы иногда можно создавать средствами операционной системы. Например, в Windows можно создать снимок любой файловой системы средствами драйвера VolSnap.sys. В Linux похожим средством может стать модуль blksnap, который пока ещё не принят в официальные исходные тексты ядра.

И, наконец, в Linux имеется две подсистемы, с помощью которых можно создавать снимки файловых систем, созданных поверх этих подсистем:

* Подсистема Device-mapper позволяет добавить к одному блочному устройству, на котором находится отслеживаемая файловая система, добавить второе блочное устройство, на котором будут сохраняться изменённые блоки, нужные мгновенному снимку. Из этих двух блочных устройств создаются ещё два блочных устройства: одно используется для монтирования отслеживаемой файловой системы, а второе используется для доступа к мгновенному снимку.
* Подсистема Logical Volume Manager, или сокращённо - LVM, позволяет объединить несколько блочных устройств в одну группу, а группу поделить на логические блочные устройства произвольного размера. В каждом из логических блочных устройств можно разместить файловую систему, а если в группе осталось свободное место, то можно создавать мгновенный снимок любого логического тома, принадлежащего этой группе. Кстати говоря, поддержка LVM также присутствует и в NetBSD.

В этой статье пойдёт речь о создании полной резервной копии баз данных MySQL, находящихся на файловой системе, расположенной на логическом томе LVM в Linux.

Создание резервной копии
------------------------

Настройка реплики
-----------------

Скрипт периодического резервного копирования
--------------------------------------------

Скрипты для настройки реплики
-----------------------------

Восстановление прав доступа на реплике
--------------------------------------

Использованные материалы
------------------------

* [Сравнение файловых систем](https://ru.wikipedia.org/wiki/%D0%A1%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D1%8B%D1%85_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC)

Дополнительные материалы
------------------------

* [snapshot UFS2 во FreeBSD](https://nix-sa.blogspot.com/2011/09/snapshot-ufs2-freebsd.html)
* [FreeBSD Documantation Portal / The Z File System (ZFS) / Managing Snapshots](https://docs.freebsd.org/en/books/handbook/zfs/#zfs-zfs-snapshot)
* [blksnap - block devices snapshots module](https://lwn.net/Articles/928311/)
* [Device-mapper snapshot support](https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/snapshot.html)
* [Device-mapper / Snapshot](https://wiki.gentoo.org/wiki/Device-mapper#Snapshot)
