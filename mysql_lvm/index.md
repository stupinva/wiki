Резервное копирование и настройка репликации MySQL с помощью LVM
================================================================

[[!tag mysql lvm backup restore snapshot]]

Содержание
----------

[[!toc startlevel=2 levels=4]]

Введение
--------

Кроме использования штатной утилиты `mysqldump` для резервного копирования баз данных можно воспользоваться мгновенными снимками файловой системы. Стоит отметить, что мгновенные снимки уступают в гибкости штатной утилите, т.к. с их помощью можно снять только полную резервную копию всех баз данных, в то время как с помощью штатной утилиты можно снимать резервные копии отдельных баз данных, таблиц или даже частей таблиц.

Из более-менее распространённых файловых систем, имеющих поддержку мгновенных снимков можно назвать:

* UFS2 во FreeBSD,
* BtrFS в Linux,
* ZFS в Solaris, FreeBSD, NetBSD и, с некоторыми оговорками, в Linux.

Кроме этого, даже если файловая система сама по себе не позволяет создавать снимки, снимки файловой системы иногда можно создавать средствами операционной системы. Например, в Windows можно создать снимок любой файловой системы средствами драйвера `VolSnap.sys`. В Linux похожим средством может стать модуль `blksnap`, который пока ещё не принят в официальные исходные тексты ядра.

И, наконец, в Linux имеется две подсистемы, с помощью которых можно создавать снимки файловых систем, созданных поверх этих подсистем:

* Подсистема Device-mapper позволяет добавить к одному блочному устройству, на котором находится отслеживаемая файловая система, добавить второе блочное устройство, на котором будут сохраняться изменённые блоки, нужные мгновенному снимку. Из этих двух блочных устройств создаются ещё два блочных устройства: одно используется для монтирования отслеживаемой файловой системы, а второе используется для доступа к мгновенному снимку.
* Подсистема Logical Volume Manager, или сокращённо - LVM, позволяет объединить несколько блочных устройств в одну группу, а группу поделить на логические блочные устройства произвольного размера. В каждом из логических блочных устройств можно разместить файловую систему, а если в группе осталось свободное место, то можно создавать мгновенный снимок любого логического тома, принадлежащего этой группе. Кстати говоря, поддержка LVM также присутствует и в NetBSD.

В этой статье пойдёт речь о создании полной резервной копии баз данных MySQL, находящихся на файловой системе, расположенной на логическом томе LVM в Linux.

Создание резервной копии
------------------------

Если в базе данных используются только таблицы формата InnoDB, то для создания простой резервной копии средствами LVM достаточно просто создать снимок логического тома с файловой системой, в которой расположены файлы баз данных MySQL:

    # lvcreate -L 10G -s vg0/storage -n storage-snapshot

Где:

* `vg0` - группа томов, содержащая логический том с интересущей нас файловой системой, в которой находятся файлы баз данных MySQL,
* `storage` - имя логического тома с файловой системой, в которой находятся файлы баз данных MySQL,
* `storage-snapshot` - мгновенный снимок, в котором будут сохраняться исходные версии изменённых блоков,
* `10G` - максимальный объём изменений логического тома, сохраняемых в снимке. Если указанный объём будет исчерпан, то снимок перейдёт в неисправное состояние и попытки его чтения будут завершаться ошибкой. В файле конфигурации `/etc/lvm/lvm.conf` можно настроить автоматическое увеличение размеров снимков вплоть до исчерпания всего свободного места в группе томов.

Полученный в результате снимок можно смонтировать, например, в каталог `/mnt/`:

    # mount /dev/vg0/storage-snapshot /mnt/

Этот снимок можно скопировать в локальный каталог или на удалённый компьютер с помощью rsync, его можно заархивировать или целиком передать по сети.

### Локальная резервная копия с помощью rsync

Для копирования снимка в локальный каталог или обновления уже имеющейся резервной копии можно воспользоваться командой следующего вида:

    # rsync -axv --delete-before /mnt/mysql/ /backup/db/

Здесь:

* `/mnt/mysql/` - путь к каталогу с файлами баз данных MySQL, который находится на смонтированном мгновенном снимке,
* `/backup/db/` - путь к каталогу с резервной копией файлов баз данных.

### Локальная резервная копия в архиве

В качестве альтернативы, можно создать архивный файл с файлами баз данных MySQL:

    # tar -cSjf /backup/db.tbz -C /mnt/mysql/ db

Где:

* `/mnt/mysql/` - путь к каталогу с файлами баз данных MySQL, который находится на смонтированном мгновенном снимке,
* `/backup/db.tbz` - имя архивного файла с резервной копией файлов баз данных MySQL,
* `db` - имя каталога внутри архивного файла, в который будет помещено содержимое каталога `/mnt/mysql/`.

### Резервная копия на удалённом сервере с помощью rsync

Чтобы скопировать файлы баз данных MySQL в каталог на удалённом компьютере, можно прибегнуть к более сложной команде:

    # rsync -axv --delete-before -e 'ssh -i ~/.ssh/id_rsa' /mnt/mysql/ backup@server.domain.tld:/backup/db/

Где:

* `/mnt/mysql/` - путь к каталогу с файлами баз данных MySQL, который находится на смонтированном мгновенном снимке,
* `server.domain.tld` - удалённый сервер, на который нужно скопировать резервную копию файлов баз данных. Если в указанном каталоге уже есть резервная копия, сделанная ранее, то она будет обновлена,
* `backup` - пользователь на удалённом сервере, имеющий доступ к этому серверу по SSH,
* `~/.ssh/id_rsa` - путь к приватному ключу, который можно использовать для входа на удалённый сервер по SSH.

### Резервная копия на удалённом сервере в виде архива

Для отправки архива на удалённый сервер, не прибегая к настройке SSH, можно привлечь утилиты `pigz` и `socat`. Применение утилиты `pigz` позволяет сжать архив, при необходимости - в несколько потоков, для передачи по сети меньшего объёма данных. Утилита `sockat` при этом занимается передачей архива в сеть и его приёмом из сети.

На принимающем сервере запустим такую команду:

    # socat -u TCP-LISTEN:4444,reuseaddr stdio > /backup/db.tbz

Здесь:

* `4444` - номер TCP-порта, на который `socat` примет одно входящее подключение,
* `/backup/db.tbz` - имя файла, в который будет записан принятый по сети архив с резервной копией файлов баз данных MySQL.

Затем на исходном сервере можно запустить формирование архива и его отправку в сеть на принимающий сервер:

    # tar -cSjf - -C /mnt/mysql/ db | pigz -k -1 -p4 - | socat -u stdio TCP:192.168.169.2:4444

Где:

* `/mnt/mysql/` - путь к каталогу с файлами баз данных MySQL, который находится на смонтированном мгновенном снимке,
* `db` - имя каталога внутри архивного файла, в который будет помещено содержимое каталога `/mnt/mysql/`.
* `-1` - минимальная степень сжатия архива для наибольшей скорости сжатия. При необходимости использовать максимальное сжатие можно указать опцию `-11`,
* `-p4` - сжатие в 4 потока. Будьте осторожны: не стоит отнимать ядра процессоров у MySQL, т.к. это может отразиться на скорости работы MySQL. Оцените, сколько процессорных ядер свободно, и укажите в этой опции их количество, а лучше - меньшее количество, чтобы оставался запас для MySQL,
* `192.168.169.2` - IP-адрес принимающего сервера,
* `4444` - номер TCP-порта удалённого сервера, на котором `socat` ожидает поступления входящих подключений.

### Резервная копия на удалённом сервере

Для отправки резервной копии файлов баз данных MySQL на удалённый сервер, не прибегая к настройке SSH, можно привлечь те же самые утилиты `tar`, `pigz` и `socat`.

На принимающем сервере запустим такую команду:

    # cd /backup/ && socat -u TCP-LISTEN:4444,reuseaddr stdio | pigz -dc -p4 - | tar xf -

Где:

* `4444` - номер TCP-порта, на который `socat` примет одно входящее подключение,
* `/backup/` - каталог, в который будет помещены файлы баз данных MySQL, принятые по сети. Имя подкаталога в данном случае будет определяться передающей стороной.

Затем на исходном сервере можно запустить формирование архива и его отправку в сеть на принимающий сервер:

    # tar -cSjf - -C /mnt/mysql/ db | pigz -k -1 -p4 - | socat -u stdio TCP:192.168.169.2:4444

Тут:

* `/mnt/mysql/` - путь к каталогу с файлами баз данных MySQL, который находится на смонтированном мгновенном снимке,
* `db` - имя подкаталога на удалённом сервере, в который будут помещены файлы баз данных MySQL,
* `-1` - минимальная степень сжатия архива для наибольшей скорости сжатия. Увеличивать степень сжатия в данном случае не имеет особого смысла, т.к. это не позволит сэкономить место на диске, но приведёт к замедлению передачи данных по сети из-за более длительного сжатия,
* `-p4` - сжатие в 4 потока. Будьте осторожны: не стоит отнимать ядра процессоров у MySQL, т.к. это может отразиться на скорости работы MySQL. Оцените, сколько процессорных ядер свободно, и укажите в этой опции их количество, а лучше - меньшее количество, чтобы оставался запас для MySQL,
* `192.168.169.2` - IP-адрес принимающего сервера,
* `4444` - номер TCP-порта удалённого сервера, на котором `socat` ожидает поступления входящих подключений.

Настройка реплики
-----------------

Скрипт периодического резервного копирования
--------------------------------------------

Скрипты для настройки реплики
-----------------------------

Восстановление прав доступа на реплике
--------------------------------------

Использованные материалы
------------------------

* [Сравнение файловых систем](https://ru.wikipedia.org/wiki/%D0%A1%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D1%8B%D1%85_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC)
* [Stephen R Lang. Setting up MySQL Master Slave Replication with LVM snapshots](https://www.stephenrlang.com/2016/08/setting-up-mysql-master-slave-replication-with-lvm-snapshot/)
* [Peter Zaitsev. Using LVM for MySQL Backup and Replication Setup](https://www.percona.com/blog/2006/08/21/using-lvm-for-mysql-backup-and-replication-setup/)

Дополнительные материалы
------------------------

* [snapshot UFS2 во FreeBSD](https://nix-sa.blogspot.com/2011/09/snapshot-ufs2-freebsd.html)
* [FreeBSD Documantation Portal / The Z File System (ZFS) / Managing Snapshots](https://docs.freebsd.org/en/books/handbook/zfs/#zfs-zfs-snapshot)
* [blksnap - block devices snapshots module](https://lwn.net/Articles/928311/)
* [Device-mapper snapshot support](https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/snapshot.html)
* [Device-mapper / Snapshot](https://wiki.gentoo.org/wiki/Device-mapper#Snapshot)
* [Understanding LVM snapshots (create, merge, remove, extend) / Automatically extend the snapshot volume](https://www.golinuxhub.com/2017/09/understanding-lvm-snapshots-create/)
