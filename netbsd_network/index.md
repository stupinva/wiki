Настройка сети в NetBSD
=======================

* [Re: ARP Address Conflict Detection and dhcpcd arping](https://mail-index.netbsd.org/tech-net/2019/10/16/msg007553.html)

Настройка WiFi
--------------

Просмотреть список доступных WiFi-сетей можно при помощи следующей команды:

    # ifconfig ath0 list scan

### Настройка сетевого интерфейса

Впишем в файл /etc/ifconfig.ath0 конфигурацию сетевого интерфейса:

    up
    dhcp

Этих настроек достаточно, однако можно вписать и дополнительные:

    up
    media autoselect
    mode 11g
    -powersave
    dhcp

### Настройка wpa_supplicant

Впишем в файл /etc/wpa_supplicant.conf следующие минимальные настройки для подключения к точке доступа:

    network = {
        ssid="ap"
        psk="p4$$w0rd"
    }

Где: ap - имя точки доступа, а p4$$w0rd - общий ключ для подключения к ней.

Можно вписать и больше настроек:

    ap_scan=1
    fast_reauth=1
    
    network={
        ssid="ap"
        scan_ssid=1
        bssid=00:11:22:33:44:55
        key_mgmt=WPA-PSK
        psk="password"
        proto=RSN
        group=CCMP
    }

В конфигурации указаны следующие опции:

* ap_scan=1 - включает пересканирование эфира в поисках точки доступа при разрыве подключения,
* fast_reauth=1 - включает быструю повторную аутентификацию по протоколу EAP,
* scan_ssid=1 - включает поиск точки доступа с указанным именем. Может пригодиться, если точка доступа обслуживает несколько сетей с разными именами или не отвечает на широковещательные запросы поиска.
* bssid=00:11:22:33:44:55 - предписывает подключаться к точке доступа только в том случае, если её MAC-адрес совпадает с указанным.
* key_mgmt=WPA-PSK - задаёт список приемлемых протоколов аутентификации, в данном случае допустимым будет только WPA с общим ключом,
* proto=RSN - задаёт список приемлемых протоколов, в данном случае допустимым будет только RSN, который соответствует протоколу WPA2,
* group=CCMP - задаёт список приемлемых алгоритмов шифрования, в данном случае допустимым будет только CCMP (шифорование AES-CBC-MAC).

Для включения демона wpa_supplicant на интерфейсе ath0 в процессе загрузки системы впишем в файл /etc/rc.conf следующие настройки:

    wpa_supplicant=YES
    wpa_supplicant_flags="-i ath0 -c /etc/wpa_supplicant.conf"

Запустим wpa_supplicant:

    # /etc/rc.d/wpa_supplicant start

### Настройка DHCP-клиента

Для настройки сетевого интерфейса по протоколу DHCP будет использоваться имеющийся в базовой системе демон dhcpcd. По умолчанию он пытается сконфигурировать на интерфейсе также адрес IPv6, а при недоступности DHCP-сервера пытается настроить самоназначаемый IP-адрес Link-Local из диапазона 169.254.0.0/16. Отключить обе эти функции можно вписав в файл /etc/dhcpcd.conf следующие настройки:

    noipv4ll
    noipv6

### Возможные проблемы

Я столкнулся только с одной проблемой. В моей домашней сети DHCP-сервер был настроен на раздачу IP-адресов из сети 169.254.253.0/24. Эти адреса принадлежат адресному пространству самоназначаемых IP-адресов Link-Local 169.254.0.0/16. DHCP-клиент ISC отрабатывал нормально, но клиент dhcpcd, имеющийся в базовой поставке NetBSD, такие IP-адреса настраивать на сетевом интерфейсе не хотел. Он получал IP-адрес, настраивал его на сетевом интерфейсе и спустя несколько секунд удалял. Чтобы dhcpcd работал исправно, мне пришлось поменять адресацию локальной сети.
