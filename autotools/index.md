Использование autotools
=======================

[[!tag c autotools autoscan aclocal autoconf automake configure.ac Makefile.am]]

Содержание
----------

[[!toc startlevel=2 levels=4]]

Подготовка заготовки configure.ac
---------------------------------

Первым делом запускаем в каталоге с файлами проекта утилиту `autoscan`:

    $ autoscan

По завершении её работы в текущем каталоге должен появиться файл `configure.auto`. Переименуем его в `configure.ac`:

    $ mv configure.auto configure.ac

Откроем файл `configure.ac` в текстовом редакторе и внесём информацию о проекте, отредактировав строчку `AC_INIT`:

    AC_INIT([view3d], [1.2-sdl2], [vladimir@stupin.su])

Где:

* `view3d` - название проекта,
* `1.2-sdl2` - версия программы,
* `vladimir@stupin.su` - адрес электронной почты сопровождающего проект/программу.

Если в проекте есть отдельный заголовочный файл, в который вынесены все опции для настройки проекта, то имя этого файла нужно вписать в строчку `AC_CONFIG_HEADER`:

    AC_CONFIG_HEADER([config.h])

Если же такого файла нет, то эту строчку нужно удалить.

В строчке `AC_CONFIG_SRCDIR` нужно указать имя главного файла, из которого система сборки `autotools` извлечёт рекурсивно все используемые заголовочные файлы:

    AC_CONFIG_SRCDIR([main.c])

Система сборки `autotools` предназначена прежде всего для сборки программ проекта GNU. У проекта GNU имеется собственный набор стандартных файлов, которые должны быть в каталоге с проектом. Для сборки других программ, не соответствующих стандартам проекта GNU, нужно добавить в строчку `AM_INIT_AUTOMAKE` опцию `foreign`:

    AM_INIT_AUTOMAKE([foreign])

Для того, чтобы в процессе компиляции программы выводились разнообразные сообщения об ошибках, которые помогают выявлять допустимые, но подозрительные, фрагменты кода, я добавляю в строчку `AM_INIT_AUTOMAKE` дополнительные опции:

    AM_INIT_AUTOMAKE([foreign -Wportability -Wall -Werror -Wsyntax])

Подготовка файла Makefile.am
----------------------------

### Сборка двоичных файлов

Теперь создадим шаблон для генерации файла `Makefile`. В простейшем случае можно ограничиться двумя строчками:

    bin_PROGRAMS = view3d
    view3d_SOURCES = vmdl.cpp idpo.cpp events.cpp main.cpp

В опции `bin_PROGRAMS` перечисляются имена выполняемых файлов, которые должны получиться в итоге сборки.

Для каждого исполняемого файла указывается по одной переменной вида `<имя>_SOURCES`, в которой перечисляются все файлы исходных текстов, необходимых для сборки этой программы.

### Документация

Если в проекте есть дополнительные файлы с документацией, которую нужно установить в систему (или поместить в двоичный пакет) вместе с собранными двоичными файлами, то их можно можно перечислить в переменной `dist_doc_DATA`:

    dist_doc_DATA = README.md ideas.txt

### Тесты

Если в программе имеются тесты, то их сборку можно настроить способом, аналогичным сборке исполняемых файлов:

    check_PROGRAMS = test
    test_SOURCES = bin.c test.c
    TESTS = $(check_PROGRAMS)

В опции `check_PROGRAMS` перечисляются имена выполняемых файлов, которые должны получиться в итоге сборки тестов.

Для каждого исполняемого файла указывается по одной переменной вида `<имя>_SOURCES`, в которой перечисляются все файлы исходных текстов, необходимых для сборки этой программы.

В переменной `TESTS` перечисляются все программы, которые нужно вызвать для тестирования проекта.

В дальнейшем запустить все тесты можно будет с помощью команды:

   $ make check

При успешном прохождении теста программа должна завершаться с нулевым кодом возврата. По окончании тестирования итоги будут сведены в таблицу следующего вида:

    make  check-TESTS
    make[1]: вход в каталог «/home/stupin/old/git/pup»
    make[2]: вход в каталог «/home/stupin/old/git/pup»
    PASS: test
    ============================================================================
    Testsuite summary for pup 1.0
    ============================================================================
    # TOTAL: 1
    # PASS:  1
    # SKIP:  0
    # XFAIL: 0
    # FAIL:  0
    # XPASS: 0
    # ERROR: 0
    ============================================================================
    make[2]: выход из каталога «/home/stupin/old/git/pup»
    make[1]: выход из каталога «/home/stupin/old/git/pup»

Учёт зависимостей
-----------------
