Шпаргалка по ClickHouse
=======================

Просмотр текущих запросов
-------------------------

Посмотреть текущие выполняемые запросы, отсортировав их по убыванию времени выполнения и количества участвующих в запросе строк, можно при помощи следующего запроса в базе данных `system`:

    SELECT elapsed,
           total_rows_approx,
           client_name,
           client_hostname,
           user,
           query
    FROM processes
    ORDER BY elapsed, total_rows_approx DESC;

Настройка времени хранения секций таблицы
-----------------------------------------

Для задания максимального времени хранения данных в таблице с последующим удалением устаревших секций таблицы можно воспользоваться запросом следующего вида:

    ALTER TABLE api_ufanet.api_fcm_notice MODIFY TTL date_create + INTERVAL 3 MONTH DELETE;

Чтобы заставить Clickhouse немедленно приступить к удалению устаревших секций, можно выполнить запрос следующего вида:

    OPTIMIZE TABLE api_ufanet.api_fcm_notice FINAL;

Стоит, однако, отметить, что устаревшие данные не будут удалены сразу по завершении выполнения этого запроса. Удаление данных выполняется в фоновом режиме. Для того, чтобы проверить, какие ещё секции остались в таблице, можно воспользоваться запросом следующего вида:

    SELECT DISTINCT partition
    FROM system.parts
    WHERE database = 'api_ufanet'
      AND table = 'api_fcm_notice';
